<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
	</head>
	<style type="text/css">
		.rlimg {
			width: 200px;
			height: 200px;
			margin: 50px auto;
			background: url(../../images/rlimg.png);
			background-size: 100%;
		}
		
		.renzheng,
		.sctp {
			width: 80%;
			margin-top: 10px;
			background: #26aa12;
			border: 1px solid #26aa12;
			line-height: 25px;
			font-size: 17px;
		}
		
		img {
			border: 0px;
		}
	</style>

	<body>
		<header id="header" class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color:#26aa12;"></a>
			<h1 class="mui-title">人脸识别</h1>
		</header>
		<div class="mui-content">
			<div class="rlimg">
				<!---->
			</div>
			<div style="text-align: center;">
				<img style="width:60%;height:100%;" src="../../images/rlgz.png" alt="" />
			</div>
			<div style="text-align: center;">
				<button type="button" class="mui-btn mui-btn-success sctp">上传图片</button>
				<button type="button" class="mui-btn mui-btn-success renzheng">认证</button>
			</div>

			<!--<button type="button" class="mui-btn mui-btn-success nex">下一步</button>-->
		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript">
			mui.init();

			function getDeviceInfo() {
				mui.plusReady(function() {
					plus.geolocation.getCurrentPosition(function(p) {

						var awLatAndLng = '{"lng": "' + p.coords.latitude + '","lat": "' + p.coords.longitude + '"}';
						var i = 0;
						var a;
						var tly1 = [];
						var wid = plus.accelerometer.watchAcceleration(function(o) {

							tly1[i] = '{"type":"' + plus.os.name + '","x":"' + o.xAxis + '","y":"' + o.yAxis + '","z":"' + o.zAxis + '"}';
							i++;
							if(i >= 2) {
								plus.accelerometer.clearWatch(wid);

							}
							if(i == 2) {
								var deviceID = plus.device.uuid; //设备ID

								var deviceIDType = fdevice(); //设备ID类型???
								var deviceModel = plus.device.model; //设备型号
								var diviceType = plus.os.name; //设备类
								var isRoot = "0"; //是否越狱
								var mac = getMac(); //网卡地址
								var systemVersion = plus.os.version; //系统版本号
								function getMac() {
									var mac = "";
									if(plus.os.name == "Android") {
										//WifiManager 
										var Context = plus.android.importClass("android.content.Context");
										var WifiManager = plus.android.importClass("android.net.wifi.WifiManager");
										var wifiManager = plus.android.runtimeMainActivity().getSystemService(Context.WIFI_SERVICE);
										var WifiInfo = plus.android.importClass("android.net.wifi.WifiInfo");
										var wifiInfo = wifiManager.getConnectionInfo();
										mac = wifiInfo.getBSSID();
									} else {
										mac = '';
									}
									return mac;
								}

								function fdevice() {
									var a = "";
									if(plus.os.name == "Android") {
										a = 'IMEI';
									} else {
										a = 'uuid';
									}
									return a;
								}
								var deviceInfo = '{"awGetGyro":[' + tly1[0] + ',' + tly1[1] + '],"awLatAndLng":' + awLatAndLng + ',"deviceID":"' + deviceID + '","deviceIDType":"' + deviceIDType + '","deviceModel":"' + deviceModel + '","diviceType":"' + diviceType + '","isRoot":"' + isRoot + '","mac":"' + mac + '","systemVersion":"' + systemVersion + '"}';
								//							
								localStorage.setItem('deviceInfo', deviceInfo);
							}
							//						
						}, function(e) {
							alert("Acceleration error: " + e.message);
						});

					}, function(e) {
						alert(e);
					});
				})

			}

			getDeviceInfo();
			var rlimg = document.querySelector('.rlimg');
			var sctp=document.querySelector('.sctp');
			mui(document.body).on('tap', '.sctp', function() {
				if(mui.os.plus) {
					var a = [{
						title: "拍照"
					}];
					plus.nativeUI.actionSheet({
						title: "上传图片",
						cancel: "取消",
						buttons: a
					}, function(b) { /*actionSheet 按钮点击事件*/
						switch(b.index) {
							case 0:
								break;
							case 1:
								getImage(); /*拍照*/
								break;

							default:
								break;
						}
					})
				}
			})

			function getImage() {
				var c = plus.camera.getCamera();
				c.captureImage(function(e) {
					//					
					var path = plus.io.convertLocalFileSystemURL(e);
					//						console.log(path);
					//压缩
					plus.zip.compressImage({
							src: e,
							dst: path,
							quality: 20,
							width: "300px",
							heihgt: "auto",
							overwrite: true,
						},
						function(zip) {
							plus.io.resolveLocalFileSystemURL(zip.target, function(entry) {
								var reader = null;
								entry.file(function(file) {
									reader = new plus.io.FileReader();
									reader.readAsDataURL(file);
									reader.onload = function(e) {
										var resimg = this.result.replace("data:image/jpeg;base64,", "");
										console.log(resimg);

										localStorage.setItem('rlsbimg', resimg);
										var hml = '<img style="width:100%;height:100%;" class="imgaa" src="data:image/jpeg;base64,' + localStorage.getItem('rlsbimg') + '" alt="" />';
											
										rlimg.innerHTML = hml;
										sctp.innerHTML="重新上传";
									}
								}, function(e) {
									console.log(e.message);
								});

							}, function(e) {
								console.log("读取拍照文件错误：" + e.message);
							});
						},
						function(error) {
							alert("Compress error!");
						});

				}, function(s) {
					console.log("error" + s);
				}, {
					filename: "_doc/head.jpg"
				})
			}
			mui(document.body).on('tap', '.nex', function() {
				mui.openWindow({
					url: 'sxjdl.html',
					id: 'sxjdl.html'
				})
			})
			var userinfo = JSON.parse(localStorage.getItem('user_info')); //用户信息
			var customerName = localStorage.getItem('customerName');
			var deviceInfo = localStorage.getItem('deviceInfo'); //陀螺仪;
			var merCode = "1000006";
			var merUserId = userinfo.uid;
			var md5IdCard = localStorage.getItem('cardid');
			var rlsbimg = localStorage.getItem('rlsbimg');

			console.log(JSON.stringify({
				companyName: '直招帮',
				deviceInfo: deviceInfo,
			}));
			//接口三 人脸识别认证
			mui(document.body).on('tap', '.renzheng', function() {
				console.log(rlsbimg);
				mui.ajax($$$.siturl + $$$.suixinjie + +1000003, {
					type: 'post',
					dataType: 'json',
					data: {
						customerName: customerName,
						md5IdCard: md5IdCard, //身份证号
						merCode: merCode, //商户号
						merUserId: merUserId, //商户用户ID
						photo: rlsbimg
					},
					success: function(data) {
						//						alert(JSON.stringify(data));
						if(data.code == '0000') {
							wn = plus.webview.create(data.url, 'test', {
								'titleNView': {
									'backgroundColor': '#fff',
									'titleText': '随薪借',
									'titleColor': '#000',
									autoBackButton: true
								}
							});
							wn.show("slide-in-right");
							//						//上传设备信息；
							mui.ajax($$$.siturl + $$$.suixinjie + 1000004, {
								type: 'post',
								dataType: 'json',
								data: {
									companyName: '直招帮',
									deviceInfo: deviceInfo,
									merCode: merCode,
									merUserId: merUserId,
								},
								success: function(data) {
									console.log(JSON.stringify(data));

								},
								error: function(a) {
									console.log(JSON.stringify(a));
								}
							})
						} else {
							mui.alert(JSON.stringify(data.msg));
						}

						//上传数据
						mui.ajax($$$.siturl + 'm=app&c=Sxj&a=addsxj', {
							type: 'post',
							dataType: 'json',
							data: {
								uid: merUserId,
								name: customerName,
								idcard: md5IdCard,
								//								tell: localStorage.getItem('tele'),
							},
							success: function(e) {
								console.log(e);
							},
							error: function(a) {
								console.log(a);
							}
						})

					},
					error: function(a) {
						console.log(JSON.stringify(a));
					}
				})
			})
		</script>
	</body>

</html>