<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
	</head>

	<body>
		<ul id="job_list2" class="mui-table-view mui-content" style="margin: 0px;padding:0px;border:0;">
			sdsd
		</ul>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript">
			mui.init({
				pullRefresh: {
					container: '#job_list2', //待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
					up: {
						height: 50, //可选.默认50.触发上拉加载拖动距离
						auto: true, //可选,默认false.自动上拉加载一次
						contentrefresh: "正在加载...", //可选，正在加载状态时，上拉加载控件上显示的标题内容
						contentnomore: '没有更多数据了', //可选，请求完毕若没有更多数据时显示的提醒内容；
						callback: pullfreshfunction //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					}
				}
			});

			function pullfreshfunction() {
				alert(11);
				var time = getNowFormatDate();
				mui.ajax($$$.siturl + 'm=App&c=index&a=searchjobsingle', {
					type: 'post',
					dataType: 'json',
					data: {
						data: localStorage.getItem('datao'),
						page: page,
						time: time,
					},
					success: function(str) {
						console.log(JSON.stringify(str));

						if(str.staus == 2) {
							mui.toast(str.msg, {
								duration: 'short',
								type: 'div'
							});
						}
						var job = str.data;
						var joblist = document.querySelector("#job_list2");

						for(var x = 0; x < job.length; x++) {
							new CreateList_index({
								id: 'job_list2',
								data: job[x]
							})
						}
						var ul = document.querySelector('#job_list2')
						var lis = ul.children;
						for(var x = 0; x < lis.length; x++) {
							lis[x].addEventListener('click', function() {
								var id = this.children[0].getAttribute('data-id');
								localStorage.setItem('jid', id);
							})
						}
						page++;
						mui('#job_list2').pullRefresh().endPullupToRefresh(false);
					},
					error: function(xhr, type, errorThrown) {
						//						mui.toast('遇到问题，正在完善',{ duration:'short', type:'div' }) ;
					}
				})

			}
			document.addEventListener("plusready", function() {
				mui.ajax($$$.siturl + 'm=App&c=index&a=hotword', {
					type: 'get',
					dataType: 'json',
					success: function(str) {
						insertdata('.insertspanhot', str);
					},
					error: function(xhr, type, errorThrown) {
						mui.toast('遇到问题，正在完善', {
							duration: 'short',
							type: 'div'
						});
					}
				})
			});

			function searchtoall() {

				var tex = document.querySelector(".inputserch").value;

				getinfoinser(tex);
				localStorage.setItem('datao', tex)
			}

			function insertdata(id, data) {
				var data = datas(id, data);
				var jobs = document.querySelector(id);
				var result = '';

				for(var i = 0; i < data.length; i++) {
					//alert(data[i].data);
					result += '<span class= "onclikto" style="width:20%;font-size:14px;line-height:35px;height:35px;text-align:center;background-color:#F0EDED;display: inline-block;text-align: center;border-radius: 5px;color:#101010;margin:5% 5% 0 0;">';
					result += data[i].data + '</span>';
					//result+='<span">'+data[i].data+'</span>';
				}
				jobs.innerHTML = result;
				blindclick();

				function datas(id, data) {
					var data = data.data;
					var ar = [];
					if(id == '.insertspanhot') {
						for(d in data) {
							var res = {};
							res.id = data[d].w_id;
							res.data = data[d].w_word;
							ar.push(res);
						}
					}
					return ar;
				}

				function blindclick() {
					mui(document.body).on('tap', '.onclikto', function(e) {
						getinfoinser(this.innerHTML);
						e.stopPropagation();
					})

				}

			}

			function getinfoinser(data) {

				var time = getNowFormatDate();

				mui.ajax($$$.siturl + 'm=App&c=index&a=searchjobsingle', {
					type: 'post',
					dataType: 'json',
					data: {
						data: data,
						page: 1,
						time: time,
					},
					success: function(str) {
						console.log(JSON.stringify(str));
						//mui.alert(str);
						if(str.staus == 2) {
							mui.toast(str.msg, {
								duration: 'short',
								type: 'div'
							});

						}

						var job = str.data;
						console.log(JSON.stringify(job));
						var joblist = document.querySelector("#job_list2");
						joblist.innerHTML = '';
						for(var x = 0; x < job.length; x++) {
							new CreateList_index({
								id: 'job_list2',
								data: job[x]
							})
						}
						// var ul = document.querySelector('#job_list2')
						//var lis = ul.children;
						/*for(var x = 0 ;x < lis.length; x++){
							lis[x].addEventListener('click',function(){
								var id = this.children[0].getAttribute('data-id');									
								localStorage.setItem('jid',id);

							})
						}*/

					},
					error: function(xhr, type, errorThrown) {
						mui.toast('遇到问题，正在完善', {
							duration: 'short',
							type: 'div'
						});
					}
				})
			}

			function CreateList_index(option) {
				this.id = option.id || 'work_detail';
				this.bg = option.bg || '#fff';
				this.data = option.data;
				this.init();
			}

			CreateList_index.prototype = {
				init: function() {
					// 处理id
					var id = this.birthId(this.id);
					// 创建并插入预制组件
					var str = this.create(this.data);
					this.insert(id, str);
				},
				birthId: function(id) {
					var query = '#' + id;
					return query;
				},
				create: function(data) {
					/*定义组件字符串*/
					var tags = data.tag_cn.split(',');
					var leng = 0;
					if(tags.length > 3) {
						leng = 3;

					} else {
						leng = tags.length;
					}
					var srce = '';
					for(var i = 0; i < leng; i++) {
						var tageclass = this.tagcolor(tags[i]);
						srce += '<span style="font-size:10px;line-height: 12px;height:16px;padding:2px 4px;box-sizing: border-box;display: inline-block;text-align: center;border-radius: 5px;margin-right:3px;" class="' + tageclass + '" >' + tags[i] + '</span>';
					}
					var result = '';
					(function(data) {
						result += '';
						result += '<li  class="mui-table-view-cell " style="box-sizing: border-box;border-bottom:1px solid #CDCDCD; margin:auto" data-id="' + data.jid + '">';
						result += '<div style="padding:0px 0px;margin:0 0 0 0 ;">';
						result += '<div style="width:26%;float:left;padding-right:13px;">';
						result += '<img src="' + $$$.imgurl + data.logo + '" style="width:100%;height:62px;border-radius: 8px;">';
						result += '</div>';
						result += '<div class="" style="float:left;width:74%;">';
						result += '<div class="" style="width:100%">';
						result += '<div  class="">';
						result += '<div class="" style="font-weight:700;font-size:14px;padding-bottom:10px;line-height: 14px;">' + data.jobs_name + '</div>';
						result += '</div>';
						result += '<div  class="" style="position: relative;font-size:12px;padding-bottom: 7px;line-height: 12px;">';
						result += '<div class="" style="color:#737373;">' + data.category_cn + '</div>';
						result += '<div class="wagecolor" style="font-size:1.5em;position:absolute;right:13px;top:0;color:#26aa12">' + data.minwage + '-' + data.maxwage + '元</div>';
						result += '</div>';
						result += '<div  class="" style="position:relative;font-size:15px;">';
						result += '<div class="">';
						result += srce;
						result += '</div>';
						result += '<div class="dis" style="position: absolute;right:13px;bottom:0;font-size:12px;top:3px">' + data.district_cn + '</div>';
						result += '</div>';
						result += '</div>';
						result += '</div>';
						result += '</div>';
						result += '</li>';
						result += ''
					})(data);
					return result;
				},
				insert: function(id, result) {
					var div = document.createElement('div');
					div.innerHTML = result;
					div.addEventListener('click', function() {
						goJobLink(div.children[0]);
					})
					var box = document.querySelector(id);
					if(box.appendChild) {
						box.insertBefore(div, box.children[0]);
					} else {
						box.insertBefore(div, box.children[0]);
					}
				},
				tagcolor: function(y) {
					if(y == '年终奖') return 'tag1';
					else if(y == '工作餐')
						return 'tag2';
					else if(y == '五险一金')
						return 'tag3';
					else if(y == '长白班')
						return 'tag4';
					else if(y == '两班倒')
						return 'tag5';
					else if(y == '双休')
						return 'tag6';
					else if(y == '工作轻松')
						return 'tag3';
					else if(y == '单休')
						return 'tag4';
					else if(y == '恒温车间')
						return 'tag5';
					else if(y == '坐着上班')
						return 'tag5';
					else
						return 'tag7';

				}
			};

			function goJobLink(dvj) {
				var jid = dvj.getAttribute('data-id');
				localStorage.setItem('jid', jid);
				mui.openWindow({
					url: '../job/job.html',
					id: 'job',
					extras: {
						//jid:jid
					},
					createNew: false, //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
					waiting: {
						autoShow: true, //自动显示等待框，默认为true
						title: '正在加载...', //等待对话框上显示的提示内容
					}
				})
			}

			function getNowFormatDate() {
				var date = new Date();
				var seperator1 = "-";
				var seperator2 = ":";
				var month = date.getMonth() + 1;
				var strDate = date.getDate();
				if(month >= 1 && month <= 9) {
					month = "0" + month;
				}
				if(strDate >= 0 && strDate <= 9) {
					strDate = "0" + strDate;
				}
				var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate +
					" " + date.getHours() + seperator2 + date.getMinutes() +
					seperator2 + date.getSeconds();
				return currentdate;
			}
		</script>
	</body>

</html>