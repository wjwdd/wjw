<!DOCTYPE html>
<html style="height:100%;width:100%;">
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<style>
			.block .t,
			.block .b ,.block .dw,.block .rm{
				padding-left:13px;
			}

			.block .t,.block .dw,.block .rm {
				font-size:13px;
				line-height: 27px;
				height:27px;
				background-color: #FDFDFE;
				width:100%;
			}
			.block .b {
				background-color: #efefef;
			}
			.block .b span {
				display: block;
				width:52px;
				height:27px;
				box-sizing: border-box;
				padding:0 13px;
				font-size:12px;
				line-height: 27px;
				border:1px solid #7D7D7D;
				border-radius: 5px;
				margin-top:8px;
				float: left;
				margin-right:11px;
			}
			.block .bb {
				/*height:50px;*/
				background-color: #FDFDFE;
				padding:18px 20px;
				/*padding-left:13px;*/
				font-size:14px;
				/*line-height: 50px;*/
				box-sizing: border-box;
				border-top:1px solid #D6D6D6;
				/*background-color: rgba(92,168,252,0.16);
				border-radius: 7px;*/
			}
			.block .bb.active {
				background-color: #eee;
			}
			.blv{
				background-color: rgba(92,168,252,0.16);
				border-radius: 7px;
				padding:10px 10px;
				
			}
			.cty{
				display: inline-block;
				padding: 5px;
				border: 1px solid #fff;
				border-radius: 5px;
				color: rgba(92,168,252,0.7);
				margin: 3px;
				background-color: rgba(255,255,255,0.7);
			}
			.zimu{
				width:100%;
				padding:5px 10px;
			}
			.sidebar{
				position:fixed;
				right:5px;
				top:30px;
				list-style: none;
				font-size: 14px;
			}
			.sidebar li{
				height:20px;
				color:#C7C7C7;
				text-align: center;
				
			}
			.sidebar li.select{
				color:#5CA8FC;		
			}
			.pop{
				position: fixed;
				top:50%;
				left:50%;
				text-align: center;
				width:100px;
				height:100px;
				margin-top:-50px;
				margin-left:-50px;
				background:rgba(0,0,0,0.5);
				border-radius: 10px;
				display: none;
				z-index: 1000;
				font-size: 30px;
				text-align:center;
				line-height: 100px;
				
			}
		</style>
	</head>

	<body style="width:100%;">
		<header id="header" class="mui-bar mui-bar-nav" style="background:#fff;position:fixed;top:0px;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" style="color:#5CA8FC;">城市选择</h1>
		</header>
		<div class="pop">
		</div>
		<!--当前定位-->
		<div class="block" style="margin-top:45px;">
			<div class="dw" style="" >
				当前定位
			</div>
			<div class="b " style="height:40px;">
				<span style="color:#5CA8FC;display: inline-block;width:100px;text-align: center;" id="cityName">
					正在获取...
				</span>
			</div>
		</div>
		<!--热门城市-->
		<div class="block" >
			<div class="rm" style="height:23px;background-color: #fff;width:100%;">
				热门城市
			</div>
			<div class="b reCity" style="height:40px;">
				<!--<span>临沂</span>
				<span>苏州</span>
				<span>济南</span>
				<span>烟台</span>
				<span>广州</span>-->
			</div>
		</div>
		<!--城市列表-->
		<div class="block" id="citylist">
			<div class="t">
				全部城市
			</div>
			<div class="zmcs">
				
			</div>
			
		</div>
		<ul class="sidebar" >
			<li id="dw">定位</li>
			<li id="rm">热门</li>
			<li id="A">A</li>
			<li id="B">B</li>
			<li id="C">C</li>
			<li id="D">D</li>
			<li id="E">E</li>
			<li id="F">F</li>
			<li id="G">G</li>
			<li id="H">H</li>
			<li id="I">I</li>
			<li id="J">J</li>
			<li id="K">K</li>
			<li id="L">L</li>
			<li id="M">M</li>
			<li id="N">N</li>
			<li id="O">O</li>
			<li id="P">P</li>
			<li id="Q">Q</li>
			<li id="R">R</li>
			<li id="S">S</li>
			<li id="T">T</li>
			<li id="U">U</li>
			<li id="V">V</li>
			<li id="W">W</li>
			<li id="X">X</li>
			<li id="Y">Y</li>
			<li id="Z">Z</li>
			<li id="Z">#</li>
		</ul>
		<div class="pop">
		</div>
	</body>
	
</html>
<script src="../../js/mui.min.js"></script>
		<script>
			mui.init({
			    beforeback: function(){
			        //获得列表界面的webview
			         //var list = plus.webview.currentWebview().opener();
			         //目标页面
			          
			         var listidx = plus.webview.getWebviewById('index1.html'); 
			         //触发列表界面的自定义事件（refresh）,从而进行数据刷新  
			         mui.fire(listidx, 'lisindex');  
			         
			        //返回true，继续页面关闭逻辑
			        return true;
			    }
			});
			//字母滑动
			var cjs=localStorage.getItem('cjs');
//			console.log(cjs);
			var sidebar=document.querySelector('.sidebar');
			var zimu=document.getElementsByClassName('zimu');
			var rm=document.querySelector('.rm');
			var dw=document.querySelector('.dw');
			var id=[];
//			console.log(sidebar.children.length);
			
			for(var i=0;i<sidebar.children.length-1;i++){
				id[i]='#'+sidebar.children[i].id;
				zmtz(id[i]);
			}
//			console.log(id);
			function zmtz(id){
				var zmli=document.querySelector(id);
				var pop=document.querySelector('.pop');
				var startY = 0;
				zmli.addEventListener('touchstart', function(evt){
//					evt.preventDefault();
					var zheight=this.offsetHeight;
					var ztop=this.offsetTop;
//					console.log(zheight);
//					console.log(ztop);
					var touch = evt.touches[0]; //获取第一个触点
			        var y = Number(touch.clientY); //页面触点Y坐标
					var maxzongh=ztop+zheight+37;
					var minzongh=ztop+37;
//					console.log(maxzongh);
//					console.log(minzongh);
					if(minzongh<y<maxzongh){
//						console.log(y);
						pop.style.display='block';
						pop.innerHTML=this.innerHTML;
						for(var i=0; i<zimu.length;i++){
							if(this.innerHTML==zimu[i].id){
								document.body.scrollTop=zimu[i].offsetTop-cjs-45;
//									console.log(document.body.scrollTop);
//									console.log(zimu[i].offsetTop+100);
							}
						}
						if(this.id==dw.className){
							document.body.scrollTop=dw.offsetTop-cjs-45;
						}
						if(this.id==rm.className){
							document.body.scrollTop=rm.offsetTop-cjs-45;
						}
					}
					
					//记录触点初始位置
						
						startY = y;
	
				}, false);
				var  b;
				sidebar.addEventListener('touchmove', function(evt){
					evt.preventDefault();
					var zheight=zmli.offsetHeight;
					var ztop=zmli.offsetTop;
					
					var touch = evt.touches[0]; //获取第一个触点
						b = Number(touch.clientY); //页面触点Y坐标
						var maxzongh=ztop+zheight+37;
						var minzongh=ztop+37;
						if(b<maxzongh&&b>minzongh){
							pop.style.display='block';
							pop.innerHTML=zmli.innerHTML;
							for(var i=0; i<zimu.length;i++){
								if(zmli.innerHTML==zimu[i].id){
									document.body.scrollTop=zimu[i].offsetTop-cjs-45;
	//									console.log(document.body.scrollTop);
	//									console.log(zimu[i].offsetTop);
								}
							}
							if(zmli.id==dw.className){
								document.body.scrollTop=dw.offsetTop-cjs-45;
							}
							if(zmli.id==rm.className){
								document.body.scrollTop=rm.offsetTop-cjs-45;
							}
						}
	
				}, false);
				zmli.addEventListener('touchend', function(evt){
					
					var zheight=this.offsetHeight;
					var ztop=this.offsetTop;
//					console.log(zheight);
//					console.log(ztop);
					var touch = evt.touches[0]; //获取第一个触点
					var y = b; //页面触点Y坐标
					var maxzongh=ztop+zheight+47;
					var minzongh=ztop+zheight+47;
					if(minzongh<y<maxzongh){
//						console.log(y);
						pop.style.display='none';
						
					}
						
					
					//记录触点初始位置
						startY = y;
	
				}, false);
			}
			
			//热门点击事件
			function toindex(data){
					var daid=data.getAttribute("data-caty");
					var dainnert=data.innerHTML;
					localStorage.setItem('cityid',daid);
					localStorage.setItem('cityName',dainnert);
                	localStorage.setItem('cityChanged',1);
                	mui.back();
			}
			
			mui.plusReady(function(){
				var str='';
				var sidebar=document.querySelector('.sidebar');
				var citylist=document.querySelector('#citylist');
				var zmcs=document.querySelector('.zmcs');
				var zimu=document.querySelector('.zimu');
				var zimu='a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z';
				var zimu1=zimu.split(",");
			     mui.ajax($$$.siturl + 'm=App&c=CityTolist&a=cityToAllApi',{
								type:'post',
								dataType:'json',
								data:{},
								success:function(data){
									var data=data.data;
									
									for(var i=0;i<zimu1.length;i++){
										//创建字母行
										var dxzu=zimu1[i].toUpperCase();
										var zimu = document.createElement('div');
									    zimu.className = 'zimu';
									    zimu.id = dxzu; 
									    zmcs.appendChild(zimu);
										zimu.innerHTML=dxzu;
										//创建ul
										var divul = document.createElement('ul');
									    divul.className = 'mui-table-view divulul cityul'; 
									    zmcs.appendChild(divul);
										
										for(var j=0;j<data.length;j++){
											var szm=data[j].spell.charAt(0);
//											console.log(zimu1[i]);
											if(zimu1[i]==szm){
												var divli = document.createElement('li');
												divli.innerHTML = data[j].categoryname;
										    	divli.className = 'mui-table-view-cell divli';
										    	divli.id=data[j].id;
										    	divul.appendChild(divli);
										    	
										    	divli.addEventListener('click',function(){
										    			
														var that = this.innerHTML;
														var that1 = this.id;
									//					console.log(that);
														//将选中的城市放在本地缓存
									                	localStorage.setItem('cityName',that);
									                	localStorage.setItem('cityChanged',1);
														localStorage.setItem('cityid',that1);
														
									                	mui.back();
//									                	mui.openWindow({
//									                 		url:'../../index.html',
//									                		id:'index',
//									                		createNew:true
//									                	});
												})
											}
											
//											
										}
										
										
										
									}
//									document.addEventListener( "plusready", onPlusReady, false );
									onPlusReady();
									
								},error:function(xhr,err){
									//alert(xhr);
								}
							
							});
						window.onscroll = function () { 
							 var t = document.documentElement.scrollTop || document.body.scrollTop;
							 
						} 

			});
			
			// 扩展API加载完毕，现在可以正常调用扩展API
			function onPlusReady() {
				var str="";
			remen();
			
			function remen(){
					mui.ajax($$$.siturl + 'm=App&c=CityTolist&a=citToHot',{
								type:'post',
								dataType:'json',
//								data:{
//									uname:login_uid,
//									password:login_pass
//								},
								success:function(data){
//									console.log(JSON.stringify(data));
									for(var i=0;i<data.data.length;i++){
										str+='<span onclick="toindex(this)" data-caty="'+data.data[i].id+'">'+data.data[i].categoryname+'</span>';
									}
									
									document.querySelector(".reCity").innerHTML=str;
								},error:function(xhr,err){
									//alert(xhr);
								}
							
							});
							
		}
				var divli=document.getElementsByClassName('divli');
				var cityName = document.querySelector('#cityName');
				wid = plus.geolocation.getCurrentPosition( function ( p ) {
					var address = p.address.city;
					var reg=/市/g;
					address=address.replace(reg,'');
//					console.log(divli.innerHTML);
					cityName.innerHTML = address;
					for(var i=0;i<divli.length;i++){
						if(address==divli[i].innerHTML){
							cityName.className=	divli[i].id;
						}				
					}
//					console.log(cityName.className);
					cityName.addEventListener('tap',function(){
									localStorage.setItem('cityid',cityName.className);
									localStorage.setItem('cityName',address);
				                	localStorage.setItem('cityChanged',1);
				                	mui.back();
						
						
					})
					}, function ( e ) {
//						alert( "Geolocation error: " + e.message );
				} );
			}
			var zimu=document.getElementsByClassName('zimu');
//			function tiaoz(a){
//				var tiaozhuan=document.getElementById(a)
//				tiaozhuan.scrollIntoView();
////				for(var i=0; i<zimu.length;i++){
////					zimu[i].style.marginTop=0+'px'
////				}
////				tiaozhuan.style.marginTop=50+'px';
//			}
			
		</script>
		
