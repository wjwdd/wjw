<!DOCTYPE html>
<html>
<head>
	<title>直招帮</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<script src="../../js/mui.min.js"></script>
		<script src="../../js/JQ1.1.13.js"></script>
	<script src="js/chat.js"></script>
</head>
<style>
	.testtooline{
		margin-right: 10px;
	}
</style>
<body>
	
	<div class="zhibanglisttoadmin"> 
		<div></div>
	</div>
	
<div  class="div_centn">
  
  <div class="div_left" >
    <hr/>
    本人的 uid
    <div class="uidtoself"> </div> <hr/>
       发给:<span class="sentofin"></span>
        <input type="hidden" class="hiddeninput" name="totoid"> <hr/>
         <div class="zhesih"></div>
    <input type="text" name="msg">
    <button class="dianji" >liao</button>
    <button class="toall" >all</button>
    
  </div>
    <div class="div_right" >
        <div class="div_right_online">在线人数:<span class="count"></span></div>
          <div class="div_right_userlist">yonghu:
            <span class="div_right_userlist_list">
            </span>
        </div>
    </div>
    
    
</div>
 <button  class="testtooline">测试是否在线</button>
</body>
<script>
	 $(function(){
	 var dom={
	       base:"http://192.168.1.200/CodeIgniter/",
	       //soketbase:"ws://127.0.0.1:7272/"
	       soketbase:"ws://192.168.1.200:7272/"
	      //base:"www.zhizhaow.com", 
	      //soketbase:"ws://www.zhizhaow.com/",
	   }
	 
	 //获取所有后台的直招帮客服 
	 	 $.get(dom.base+"home/home/getadmin?",{},function(src){
					ListToAdmin({id:".zhibanglisttoadmin",list:src.data});

				//console.dir(src.data);
          },"JSON")
	  var userinfo=localStorage.getItem('user_info');
	  var uid = JSON.parse(userinfo)['username'];
    $(".uidtoself").text(uid);
      connect(); 
      function connect() {
         ws = new WebSocket(dom.soketbase);
         ws.onopen = onopen;
         ws.onmessage = onmessage; 
      }
      // 连接建立时发送登录信息
      function onopen()
      {

      }
      
      function onmessage(e){
        
           var dat=e.data;
           var msgs=JSON.parse(dat);
           if(msgs.type=='ping'){
               return;
           }
           if(msgs.type=='conn'){
           
             clientid=msgs.clientid;
              $.get(dom.base+"home/home/servertobind?uid="+uid+"&clientid="+clientid,{},function(src){
                 	//alert(src);
                 var msg=$("input[name=msg]").val('');
              })
           }
        
          if(msgs.type=='count'){
              //console.dir(msgs.msg);
               $(".count").html(msgs.msg);
               return;
           }
           if(msgs.type=='msg'){
            	 console.dir(msgs);
             $(".zhesih").append("<hr/>");
               $(".zhesih").append(msgs.msg);
               return;
           } 
           if(msgs.type=='closetoall'){
           }

           if(msgs.type=='onlineuser'){
                //console.dir(msgs.msg);
               // onlineuse(msgs.msg);
           }
      }

      
      function onclose(){
       		 alert("关闭连接");
      }

      

      function onlineuse(data){
           $(".div_right_online_count").html(data.length);
           var userlist="<div>";
           for (var i = data.length - 1; i >= 0; i--) {
            if(data[i].uid==uid){
              continue;
            }
            userlist +=   "<span>"  + data[i].uid        +    "</span>:" ;
            userlist +=   "<span>"  + data[i].nickname   + "</span>";
            userlist +=   '<button  onclick="yicanguid(this)" data-clineid="'+ data[i].uid +'"  data-uid="' +data[i].uid+ '">发送消息</button>';
            userlist +=   "<div></div>"
           }
           userlist  +=  "</div>"; 
          $(".div_right_userlist_list").html(userlist);
      }
  
        $(".dianji").click(function(){
           var touid=$("input[name=totoid]").val()
           if(touid==undefined || touid == ''){
           		alert("选择客服");
               return;
           }
           var msg=$("input[name=msg]").val(); 

           $.get(dom.base+"home/home/isonline?uid="+touid,{},function(src){
           		
             	if(src=="0"){
             		alert("该客服不在线，请选择其他客服吧");
             		return;
             	}
             	//发送给对方、
             	//获取用户信息
             	var userinfo=localStorage.getItem('user_info'); 
             	
             	 $.get(dom.base+"home/home/sedtouid?msg="+msg+"&touid="+touid+'&fromuid='+uid+'&clientid='+clientid+"&info="+userinfo,{},function(){
		              var msg=$("input[name=msg]").val('');   
		         })
           })
           
           
         })
         $(".toall").click(function(){
           var msg=$("input[name=msg]").val();     
           $.get(dom.base+"home/home/sedtoall?msg="+msg+'&fromuid='+uid+'&clientid='+clientid,{},function(){
              var msg=$("input[name=msg]").val('');   
           })
         }) 
         
         
    $(".testtooline").click(function(){
		 var uid=$("input[name=totoid]").val();
		$.get(dom.base+"home/home/isonline?uid="+uid,{},function(src){
             	alert(src);
          })
    	
    })
	
//zhibanglisttoadmin
             /* var es = new EventSource("senctoall?");
                es.addEventListener("message",function(e){
                   var data=JSON.parse(e.data);
                   $(".div_right_online_count").html(data.count);
                },false);//使用false表示在冒泡阶段处理事件，而不是捕获阶段。
              */ 
         })
 
   function yicanguid(data){
         var datauid=$(data).attr("data-uid");
         $("input[name=totoid]").val(datauid);
         //alert($(data).attr("data-clineid"));
         $(".sentofin").html($(data).attr("data-clineid"));

   }
    function GetRandomNum(Min,Max)
    {    
        var Range = Max - Min;   
        var Rand = Math.random();   
        return(Min + Math.round(Rand * Range));   
    } 

   function ListToAdmin(option){
   		this.id=option.id;
   		this.list=option.list;
   		var ele = document.querySelector(id);
   		
   		var data=this.list;

		for(var i=0; i<data.length;i++){
			folistsinge(ele,data[i]);
		} 
		
   		//console.dir(JSON.stringify(this.list));  
   		
   		
   }
  
	function folistsinge(id,data){
		console.dir(id);
		var div2 = document.createElement('div');
		div2.setAttribute("data-uname",data.uname);
		div2.setAttribute("data-fullname",data.fullname);
		var div='<div data-uid="'+data.uname+'">'
			div +=data.fullname
			div +='</div>'
			div2.innerHTML=div;
		if(id.appendChild) {
			id.appendChild(div2); 
		} else {
			id.append(div2);
		}
		div2.addEventListener('click',function(){
			var attr=div2.getAttribute('data-uname');
			document.querySelector(".sentofin").innerHTML=div2.getAttribute('data-fullname');
			document.querySelector(".hiddeninput").value=div2.getAttribute('data-uname');
		})
	}
	 
	 
</script>
</html>