<!DOCTYPE html>
<html lang="en" ng-app="chatCtr">

	<head>
		<meta charset="UTF-8">
		<title>Document</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />

		<link rel="stylesheet" href="../../css/mui.min.css">

		<script src="../../js/mui.min.js"></script>

	</head>
	<style type="text/css">
		.testtooline {
			margin-right: 10px;
		}
		
		.zhesih {
			width: 100%;
		}
		
		#msg-list {
			height: 100%;
			overflow: auto;
			-webkit-overflow-scrolling: touch;
		}
		
		.msg-item {
			padding: 8px;
			clear: both;
		}
		
		.msg-item .mui-item-clear {
			clear: both;
		}
		
		.msg-item .msg-user {
			width: 38px;
			height: 38px;
			border: solid 1px #d3d3d3;
			display: inline-block;
			background: #fff;
			border-radius: 3px;
			vertical-align: top;
			text-align: center;
			float: left;
			padding: 3px;
			color: #ddd;
		}
		
		.msg-item .msg-user-img {
			width: 38px;
			height: 38px;
			border: solid 1px #d3d3d3;
			display: inline-block;
			background: #fff;
			border-radius: 3px;
			vertical-align: top;
			text-align: center;
			float: left;
			padding: 3px;
			color: #ddd;
		}
		
		.admin-userimg {
			width: 38px;
			height: 38px;
			display: inline-block;
			border-radius: 3px;
			vertical-align: top;
			text-align: center;
			float: left;
			color: #ddd;
		}
		
		.admin-name {
			line-height: 38px;
			margin-left: 10px;
			display: inline-block;
		}
		
		.msg-item .msg-content {
			display: inline-block;
			border-radius: 5px;
			border: solid 1px #d3d3d3;
			background-color: #FFFFFF;
			color: #333;
			padding: 8px;
			vertical-align: top;
			font-size: 15px;
			position: relative;
			margin: 0px 8px;
			max-width: 75%;
			min-width: 35px;
			float: left;
		}
		
		.msg-item .msg-content .msg-content-inner {
			overflow-x: hidden;
		}
		
		.msg-item .msg-content .msg-content-arrow {
			position: absolute;
			border: solid 1px #d3d3d3;
			border-right: none;
			border-top: none;
			background-color: #FFFFFF;
			width: 10px;
			height: 10px;
			left: -5px;
			top: 12px;
			-webkit-transform: rotateZ(45deg);
			transform: rotateZ(45deg);
		}
		
		.msg-item-self .msg-user,
		.msg-item-self .msg-content {
			float: right;
		}
		
		.msg-item-self .msg-content .msg-content-arrow {
			left: auto;
			right: -5px;
			-webkit-transform: rotateZ(225deg);
			transform: rotateZ(225deg);
		}
		
		.msg-item-self .msg-content,
		.msg-item-self .msg-content .msg-content-arrow {
			background-color: #4CD964;
			color: #fff;
			border-color: #2AC845;
		}
		
		footer {
			position: fixed;
			width: 100%;
			height: 50px;
			min-height: 50px;
			border-top: solid 1px #bbb;
			left: 0px;
			bottom: 0px;
			overflow: hidden;
			padding: 0px 50px 0 10px;
			background-color: #fafafa;
		}
		
		.footer-left {
			position: absolute;
			width: 50px;
			height: 50px;
			left: 0px;
			bottom: 0px;
			text-align: center;
			vertical-align: middle;
			line-height: 100%;
			padding: 12px 4px;
		}
		
		.footer-right {
			position: absolute;
			width: 50px;
			height: 50px;
			right: 0px;
			bottom: 0px;
			text-align: center;
			vertical-align: middle;
			line-height: 100%;
			padding: 12px 5px;
			display: inline-block;
		}
		
		.footer-center {
			height: 100%;
			padding: 5px 0px;
		}
		
		.footer-center [class*=input] {
			width: 100%;
			height: 100%;
			border-radius: 5px;
		}
		
		.footer-center .input-text {
			background: #fff;
			border: solid 1px #ddd;
			padding: 10px !important;
			font-size: 16px !important;
			line-height: 18px !important;
			font-family: verdana !important;
			overflow: hidden;
		}
		
		.footer-center .input-sound {
			background-color: #eee;
		}
		
		footer .mui-icon {
			color: #000;
		}
		
		footer .mui-icon:active {
			color: #007AFF !important;
		}
		
		footer .mui-icon-paperplane:before {
			content: "发送";
		}
		
		footer .mui-icon-paperplane {
			/*-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);*/
			font-size: 16px;
			word-break: keep-all;
			line-height: 100%;
			padding-top: 6px;
			color: rgba(0, 135, 250, 1);
		}
	</style>

	<body ng-controller="mychatCtrl">
		<header id="header" class="mui-bar mui-bar-nav">
			<a id="toIndex" class="wagecolor mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" ng-bind="title"></h1>
		</header>
		<div class="mui-content">
			<div id="msg-list">
				<div ng-class="msgitem(y.classname)" ng-repeat="y in mexiaoxi">
					<img ng-class="imgmsgitem(y.classnameimg)" ng-src={{y.logo}} alt="" />
					<div class="msg-content">
						<div class="msg-content-inner" ng-bind="y.msg">

						</div>
						<div class="msg-content-arrow"></div>
					</div>
				</div>

			</div>
		</div>
		<footer>
			<div class="footer-center">
				<textarea id="msg-text" type="text" name="msg" class="input-text" ng-model="xiaoxi"></textarea>

			</div>
			<label for="" class="footer-right">
				<i id="msg-type" class="mui-icon mui-icon-paperplane dianji" ng-click="fasong(this)"></i>
			</label>
		</footer>
	</body>
	<script src="../../js/ag1.46.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/factory.js" type="text/javascript" charset="utf-8"></script>
	<script>
		angular.module('chatCtr', ['myApp'])
			.controller('mychatCtrl', function($scope, $http, $data) {
				$scope.imgurl = $$$.imgurl;
				$scope.title = localStorage.getItem('title');
				//				if(localStorage.getItem('liaotian')==null){
				//					$scope.mexiaoxi =[];
				//				}else{
				//					console.log(localStorage.getItem('liaotian'));
				//					$scope.mexiaoxi =localStorage.getItem('liaotian');
				//}
				$scope.mexiaoxi=[];
				localStorage.getItem('lixianarr');
				
				var lxxx=JSON.parse(localStorage.getItem('lixianarr'));
				console.log(JSON.stringify(lxxx));
				for(var i=0;i<lxxx.length;i++){
					if(lxxx[i].admin==localStorage.getItem('admin')){
						$scope.mexiaoxi.push({
							"msg": lxxx[i].msg,
							"logo": lxxx[i].logo,
							"classname": "msg-item",
							"classnameimg": "msg-user-img"
						})
					}
				}
//				$scope.mexiaoxi = JSON.parse(localStorage.getItem('lixianarr'));
				(function($) {
					var dom = {
						base: "http://192.168.1.111/CodeIgniter/",
						soketbase: "ws://192.168.1.111:7272/",
//						base: "http://www.zhizhaow.com/",
//						soketbase: "ws://www.zhizhaow.com:7272/",
					}

					var userinfo = localStorage.getItem('user_info');
					var uid = '13' + JSON.parse(userinfo)['username'] + '448';
					var userid = JSON.parse(userinfo)['username'];
					connect();
					//离线渲染
					//					$data.lixianxuanran(dom.base, userid).success(function(data) {
					//						//						console.log(JSON.stringify(data));
					//						var data = data.data;
					//						console.log(JSON.stringify(data));
					//						for(var i = 0; i < data.length; i++) {
					//							$scope.mexiaoxi.push({
					//								"msg": data[i].msg,
					//								"logo": data[i].info.logo,
					//								"classname": "msg-item",
					//								"classnameimg": "msg-user-img"
					//							});
					//						}
					//					})

					function connect() {
						ws = new WebSocket(dom.soketbase);
						ws.onopen = onopen;
						ws.onmessage = onmessage;
					}
					// 连接建立时发送登录信息
					function onopen() {

					}

					function onmessage(e) {

						var dat = e.data;
						//						console.log(dat);
						var msgs = JSON.parse(dat);
						if(msgs.type == 'ping') {
							return;
						}
						if(msgs.type == 'conn') {

							clientid = msgs.clientid;
							$data.conn(dom.base, uid, clientid).success(function(src) {
								//								console.log(src);
							})

						}

						if(msgs.type == 'count') {
							return;
						}

						if(msgs.type == 'msg') {
							var imgadmin = localStorage.getItem('adminimg');
							console.log(imgadmin);
							$data.kefu(dom.base).success(function(src) {
								$scope.mexiaoxi.push({
									"msg": msgs.msg,
									"logo": imgadmin,
									"classname": "msg-item",
									"classnameimg": "msg-user-img"
								});
								

							})

							return;
						}
						if(msgs.type == 'closetoall') {}

						if(msgs.type == 'onlineuser') {
							//console.dir(msgs.msg);
							// onlineuse(msgs.msg);
						}
					}

					function onclose() {
						alert("关闭连接");
					}

					function onlineuse(data) {
						//						$(".div_right_online_count").html(data.length);
						//						var userlist = "<div>";
						//						for(var i = data.length - 1; i >= 0; i--) {
						//							if(data[i].uid == uid) {
						//								continue;
						//							}
						//							userlist += "<span>" + data[i].uid + "</span>:";
						//							userlist += "<span>" + data[i].nickname + "</span>";
						//							userlist += '<button  onclick="yicanguid(this)" data-clineid="' + data[i].uid + '"  data-uid="' + data[i].uid + '">发送消息</button>';
						//							userlist += "<div></div>"
						//						}
						//						userlist += "</div>";
						//						$(".div_right_userlist_list").html(userlist);
					}
					$scope.msgitem = function(e) {
						return e;
					}
					$scope.imgmsgitem = function(e) {

						return e;
					}
					$scope.fasong = function() {
						var touid = localStorage.getItem('admin');
						//console.log(localStorage.getItem('admin'));
						$data.fasong(dom.base, touid).success(function(src) {
//							console.log(src);
							var msg = $scope.xiaoxi;

							if(src == 1) {
								$data.zaixianfasong(dom.base, msg, touid, uid, clientid, userinfo).success(function(src) {

									$scope.mexiaoxi.push({
										"msg": msg,
										"logo": $$$.imgurl + JSON.parse(userinfo).avatars,
										"classname": "msg-item msg-item-self",
										"classnameimg": "msg-user"
									});
									
									$scope.xiaoxi ='';
								})
							} else if(src == 0) {
								alert(0);
								$data.lixianfasong(dom.base, msg, touid, uid, userinfo).success(function(src) {

									$scope.mexiaoxi.push({
										"msg": msg,
										"logo": $$$.imgurl + JSON.parse(userinfo).avatars,
										"classname": "msg-item msg-item-self",
										"classnameimg": "msg-user"
									});
									
									$scope.xiaoxi ='';
								})
							}
						})
					}
				})(mui)

			})
	</script>

</html>