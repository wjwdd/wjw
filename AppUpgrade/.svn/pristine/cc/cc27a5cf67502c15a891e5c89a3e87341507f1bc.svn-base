<!DOCTYPE html>
<html ng-app="chatCtr">

	<head>
		<title>直招帮</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="../../css/mui.min.css" />
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/JQ1.1.13.js"></script>
		<script src="js/chat.js"></script>
	</head>
	<style>
		.admin-userimg {
			width: 38px;
			height: 38px;
			display: inline-block;
			border-radius: 3px;
			vertical-align: top;
			text-align: center;
			float: left;
			color: #ddd;
		}
		
		.admin-name {
			line-height: 38px;
			margin-left: 10px;
			display: inline-block;
		}
		
		.chatcount {
			/*display: none;*/
			width: 20px;
			height: 20px;
			border-radius: 50%;
			background: #ff0000;
			color: #fff;
			font-size: 15px;
			text-align: center;
			line-height: 20px;
			float: right;
			margin-top: 9px;
		}
	</style>

	<body ng-controller="mychatCtrl">
		<header id="header" class="mui-bar mui-bar-nav">
			<a id="toIndex" class="wagecolor mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">客服</h1>
		</header>
		<ul class="zhibanglisttoadmin mui-table-view" style="margin-top:72px;">
			<li class="mui-table-view-cell chartlist" ng-repeat='x in data' ng-click="openchat(this)" data-uid={{x.uname}}>
				<img class="admin-userimg" ng-src={{x.logo}} alt="" />
				<div class="admin-name" ng-bind="x.fullname"></div>
				<span class="chatcount" ng-hide="x.count== undefined||x.count==0" ng-bind="x.count"></span>
			</li>
		</ul>
		
	</body>
	<script src="../../js/ag1.46.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/factory.js" type="text/javascript" charset="utf-8"></script>
	<script>
		angular.module('chatCtr', ['myApp'])
			.controller('mychatCtrl', function($scope, $http, $data) {

				$(function() {

					$scope.imgurl = $$$.imgurl;
					var dom = {
						//						base: "http://192.168.1.111/CodeIgniter/",
						//						soketbase: "ws://192.168.1.111:7272/",
						base: "http://www.zhizhaow.com/",
						soketbase: "ws://www.zhizhaow.com:7272/",
					}
					var userinfo = localStorage.getItem('user_info');
					var uid = '13' + JSON.parse(userinfo)['username'] + '448';
					var userid = JSON.parse(userinfo)['username'];
					var arr = [];
					//消息数增加
					mui.plusReady(function() {
						var self = plus.webview.currentWebview();
						var arr = [];
						self.countid.sort();
						for(var i = 0; i < self.countid.length;) {
							var count = 0;
							for(var j = i; j < self.countid.length; j++) {
								if(self.countid[i] === self.countid[j]) {
									count++;
								}
							}
							arr.push({
								id: self.countid[i],
								count: count
							})
							i += count;
						}

						//						console.log("extras:" + self.count);
						$data.kefu(dom.base).success(function(src) {
							//						console.log(JSON.stringify(src));
							$scope.data = src.data;
							for(var i = 0; i < src.data.length; i++) {
								for(var j = 0; j < arr.length; j++) {
									if(arr[j].id == src.data[i].uname) {
										src.data[i].count = arr[j].count;
									}
								}
							}
						})
					})

					var arr = [];
					//离线渲染

					$scope.openchat = function(e) {
						//						console.log(e.x.uname);
						localStorage.setItem('admin', e.x.uname);
						localStorage.setItem('adminimg', e.x.logo);
						localStorage.setItem('title', e.x.fullname);
						mui.openWindow({
							url: 'chat.html',
							id: 'chat.html',
							createNew: false, //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
							waiting: {
								autoShow: true, //自动显示等待框，默认为true
								title: '正在加载...', //等待对话框上显示的提示内容
							}
						})
						//						console.log(e.x.count);
						//点击详情页消息数消失
						var count = e.x.count;
						var lisindex = plus.webview.getWebviewById('index');
						var xiaoxide = plus.webview.getWebviewById('xiaoxi.html');
						mui.fire(lisindex, 'lisindexId', {

							count: count,
						});
						mui.fire(xiaoxide, 'xiaoxideId', {
							id: e.x.uname,
							count: count,
						});
						e.x.count = 0;
					}
				})
			})
	</script>

</html>