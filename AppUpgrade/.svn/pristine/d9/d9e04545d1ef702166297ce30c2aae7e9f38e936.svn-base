<!DOCTYPE html>
<html>

	<head>
		<title>直招帮</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="../../css/mui.min.css" />
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/JQ1.1.13.js"></script>
		<script src="js/chat.js"></script>
	</head>
	<style>
		.testtooline {
			margin-right: 10px;
		}
		
		.zhesih {
			width: 100%;
		}
		
		#msg-list {
			height: 100%;
			overflow: auto;
			-webkit-overflow-scrolling: touch;
		}
		
		.msg-item {
			padding: 8px;
			clear: both;
		}
		
		.msg-item .mui-item-clear {
			clear: both;
		}
		
		.msg-item .msg-user {
			width: 38px;
			height: 38px;
			border: solid 1px #d3d3d3;
			display: inline-block;
			background: #fff;
			border-radius: 3px;
			vertical-align: top;
			text-align: center;
			float: left;
			padding: 3px;
			color: #ddd;
		}
		
		.msg-item .msg-user-img {
			width: 38px;
			height: 38px;
			display: inline-block;
			border-radius: 3px;
			vertical-align: top;
			text-align: center;
			float: left;
			color: #ddd;
		}
		
		.admin-userimg {
			width: 38px;
			height: 38px;
			display: inline-block;
			border-radius: 3px;
			vertical-align: top;
			text-align: center;
			float: left;
			color: #ddd;
		}
		
		.admin-name {
			line-height: 38px;
			margin-left: 10px;
			display: inline-block;
		}
		
		.msg-item .msg-content {
			display: inline-block;
			border-radius: 5px;
			border: solid 1px #d3d3d3;
			background-color: #FFFFFF;
			color: #333;
			padding: 8px;
			vertical-align: top;
			font-size: 15px;
			position: relative;
			margin: 0px 8px;
			max-width: 75%;
			min-width: 35px;
			float: left;
		}
		
		.msg-item .msg-content .msg-content-inner {
			overflow-x: hidden;
		}
		
		.msg-item .msg-content .msg-content-arrow {
			position: absolute;
			border: solid 1px #d3d3d3;
			border-right: none;
			border-top: none;
			background-color: #FFFFFF;
			width: 10px;
			height: 10px;
			left: -5px;
			top: 12px;
			-webkit-transform: rotateZ(45deg);
			transform: rotateZ(45deg);
		}
		
		.msg-item-self .msg-user,
		.msg-item-self .msg-content {
			float: right;
		}
		
		.msg-item-self .msg-content .msg-content-arrow {
			left: auto;
			right: -5px;
			-webkit-transform: rotateZ(225deg);
			transform: rotateZ(225deg);
		}
		
		.msg-item-self .msg-content,
		.msg-item-self .msg-content .msg-content-arrow {
			background-color: #4CD964;
			color: #fff;
			border-color: #2AC845;
		}
		
		footer {
			position: fixed;
			width: 100%;
			height: 50px;
			min-height: 50px;
			border-top: solid 1px #bbb;
			left: 0px;
			bottom: 0px;
			overflow: hidden;
			padding: 0px 50px 0 10px;
			background-color: #fafafa;
		}
		
		.footer-left {
			position: absolute;
			width: 50px;
			height: 50px;
			left: 0px;
			bottom: 0px;
			text-align: center;
			vertical-align: middle;
			line-height: 100%;
			padding: 12px 4px;
		}
		
		.footer-right {
			position: absolute;
			width: 50px;
			height: 50px;
			right: 0px;
			bottom: 0px;
			text-align: center;
			vertical-align: middle;
			line-height: 100%;
			padding: 12px 5px;
			display: inline-block;
		}
		
		.footer-center {
			height: 100%;
			padding: 5px 0px;
		}
		
		.footer-center [class*=input] {
			width: 100%;
			height: 100%;
			border-radius: 5px;
		}
		
		.footer-center .input-text {
			background: #fff;
			border: solid 1px #ddd;
			padding: 10px !important;
			font-size: 16px !important;
			line-height: 18px !important;
			font-family: verdana !important;
			overflow: hidden;
		}
		
		.footer-center .input-sound {
			background-color: #eee;
		}
		
		footer .mui-icon {
			color: #000;
		}
		
		footer .mui-icon:active {
			color: #007AFF !important;
		}
		
		footer .mui-icon-paperplane:before {
			content: "发送";
		}
		
		footer .mui-icon-paperplane {
			/*-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);*/
			font-size: 16px;
			word-break: keep-all;
			line-height: 100%;
			padding-top: 6px;
			color: rgba(0, 135, 250, 1);
		}
		#chatz{
			overflow: hidden;
		}
	</style>

	<body>
		<div id="chatz1">
			<header id="header" class="mui-bar mui-bar-nav">
				<a id="toIndex" class="wagecolor mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title">客服</h1>
			</header>
			<ul class="zhibanglisttoadmin mui-table-view" style="margin-top:50px;">
				<div></div>
			</ul>
		</div>
		<div id="chatz" style="none">
			<header id="header1" class="mui-bar mui-bar-nav" style="display: none;">
				<a class="fanhui mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title titlekefu">sd</h1>
			</header>
			<div class="mui-content">
				
			</div>
			<footer style="display: none;">

				<div class="footer-center">
					<textarea id="msg-text" type="text" name="msg" class="input-text"></textarea>

				</div>
				<label for="" class="footer-right">
						<i id="msg-type" class="mui-icon mui-icon-paperplane dianji"></i>
					</label>
			</footer>
		</div>
		<!--<input type="text" name="msg">-->
		<!--<button class="dianji">liao</button>
			<button class="toall">all</button>-->

		<div class="div_left" style="display:none;">
			<hr/> 本人的 uid
			<div class="uidtoself"> </div>
			<hr/> 发给:
			<span class="sentofin"></span>
			<input type="hidden" class="hiddeninput" name="totoid">
			<hr/>
		</div>
		<div class="div_right" style="display:none;">
			<div class="div_right_online">在线人数:<span class="count"></span></div>
			<div class="div_right_userlist">yonghu:
				<span class="div_right_userlist_list">
            </span>
			</div>
		</div>

		</div>
		<button class="testtooline" style="display:none;">测试是否在线</button>
	</body>
	<script>
		$(function() {
			var dom = {
				base: "http://192.168.1.111/CodeIgniter/",
				//soketbase:"ws://127.0.0.1:7272/"
				soketbase: "ws://192.168.1.111:7272/"
				//base:"www.zhizhaow.com", 
				//soketbase:"ws://www.zhizhaow.com/",
			}

			//获取所有后台的直招帮客服  
			$.get(dom.base + "home/home/getadmin?", {}, function(src) {
				ListToAdmin({
					id: ".zhibanglisttoadmin",
					list: src.data
				});

				//console.dir(src.data);
			}, "JSON");
			var userinfo = localStorage.getItem('user_info');
			var uid = '13' + JSON.parse(userinfo)['username'] + '448';
			var c;
			$(".uidtoself").text(uid);
			connect();
			
			//离线消息渲染
			$.get(dom.base + "home/home/getallformmdsg?uid="+uid,{},function(data){
	           console.log(JSON.parse(data));
	           var data=JSON.parse(data);
	           for(var i=0;i<data.data.length;i++){
	           		c = $('.admin-userimg[data-uid='+msgs.fromuid+']').attr("src");
					xiaoxi(msgs.msg, 'msg-item', c, 'msg-user-img',msgs.fromuid);
	           }
	      	})
			function connect() {
				ws = new WebSocket(dom.soketbase);
				ws.onopen = onopen;
				ws.onmessage = onmessage;
			}
			// 连接建立时发送登录信息
			function onopen() {

			}

			function onmessage(e) {

				var dat = e.data;
				var msgs = JSON.parse(dat);
				if(msgs.type == 'ping') {
					return;
				}
				if(msgs.type == 'conn') {

					clientid = msgs.clientid;
					$.get(dom.base + "home/home/servertobind?uid=" + uid + "&clientid=" + clientid, {}, function(src) {
						//alert(src);
						var msg = $("input[name=msg]").val('');
					})
				}

				if(msgs.type == 'count') {
					//console.dir(msgs.msg);
					$(".count").html(msgs.msg);
					return;
				}
				
				if(msgs.type == 'msg') {
//					console.dir(msgs.fromuid);
					c = $('.admin-userimg[data-uid='+msgs.fromuid+']').attr("src");
					
					xiaoxi(msgs.msg, 'msg-item', c, 'msg-user-img',msgs.fromuid);
					return;
				}
				if(msgs.type == 'closetoall') {}

				if(msgs.type == 'onlineuser') {
					//console.dir(msgs.msg);
					// onlineuse(msgs.msg);
				}
			}

			function onclose() {
				alert("关闭连接");
			}

			function onlineuse(data) {
				$(".div_right_online_count").html(data.length);
				var userlist = "<div>";
				for(var i = data.length - 1; i >= 0; i--) {
					if(data[i].uid == uid) {
						continue;
					}
					userlist += "<span>" + data[i].uid + "</span>:";
					userlist += "<span>" + data[i].nickname + "</span>";
					userlist += '<button  onclick="yicanguid(this)" data-clineid="' + data[i].uid + '"  data-uid="' + data[i].uid + '">发送消息</button>';
					userlist += "<div></div>"
				}
				userlist += "</div>";
				$(".div_right_userlist_list").html(userlist);
			}

			$("body").on('click', ".dianji", function() {

				var touid = $("input[name=totoid]").val()
				if(touid == undefined || touid == '') {
					alert("选择客服");
					return;
				}
				var msg = $("textarea[name=msg]").val();
				$.get(dom.base + "home/home/isonline?uid=" + touid, {}, function(src) {
					//发送给对方、
					//获取用户信息
					var userinfo = localStorage.getItem('user_info');

					if(msg == '') {
						alert('不能为空');
						return false;
					}
					if(src == "0") {
						alert(111);
						//离线
						var c = $$$.imgurl + JSON.parse(userinfo).avatars;
						xiaoxi(msg, 'msg-item msg-item-self', c,'msg-user',touid);
						$.get(dom.base + "home/home/offlinemsg?msg=" + msg + "&touid=" + touid + '&fromuid=' + uid, function() {
							var msg = $("textarea[name=msg]").val('');
						})
					} else {
						var c = $$$.imgurl + JSON.parse(userinfo).avatars;

						xiaoxi(msg, 'msg-item msg-item-self', c, 'msg-user',touid);
						$.get(dom.base + "home/home/sedtouid?msg=" + msg + "&touid=" + touid + '&fromuid=' + uid + '&clientid=' + clientid + "&info=" + userinfo, {}, function() {
							var msg = $("textarea[name=msg]").val('');
						})
					}
				})

			})
			$(".toall").click(function() {
				var msg = $("input[name=msg]").val();
				$.get(dom.base + "home/home/sedtoall?msg=" + msg + '&fromuid=' + uid + '&clientid=' + clientid, {}, function() {
					var msg = $("textarea[name=msg]").val('');
				})
			})

			$(".testtooline").click(function() {
				var uid = $("input[name=totoid]").val();
				$.get(dom.base + "home/home/isonline?uid=" + uid, {}, function(src) {
					alert(src);
				})

			})
			$('body').on('click', '.fanhui', function() {
				document.querySelector('#header').style.display = 'block';
				document.querySelector('#chatz1').style.display = 'block';
				document.querySelector('#chatz').style.display = 'none';
				document.querySelector('#header1').style.display = 'none';
				document.querySelector('footer').style.display = 'none';
				
			})

			function xiaoxi(a, b, c, d,e) {
				var xiaoxihtml = '';
				xiaoxihtml += '<div class="zhesih ' + b + '">';
				xiaoxihtml += '	<img class="' + d + '" src="' + c + '" alt="" />';
				xiaoxihtml += '	<div class="msg-content">';
				xiaoxihtml += '		<div class="msg-content-inner">';
				xiaoxihtml += a;
				xiaoxihtml += '		</div>';
				xiaoxihtml += '		<div class="msg-content-arrow"></div>';
				xiaoxihtml += '	</div>';
				xiaoxihtml += '</div>';
				
				$('#msg-list[data-uid="'+e+'"]').append(xiaoxihtml);
			}
			//zhibanglisttoadmin
			/* var es = new EventSource("senctoall?");
			   es.addEventListener("message",function(e){
			      var data=JSON.parse(e.data);
			      $(".div_right_online_count").html(data.count);
			   },false);//使用false表示在冒泡阶段处理事件，而不是捕获阶段。
			 */
		})

		function yicanguid(data) {
			var datauid = $(data).attr("data-uid");
			$("input[name=totoid]").val(datauid);
			//alert($(data).attr("data-clineid"));
			$(".sentofin").html($(data).attr("data-clineid"));

		}

		function GetRandomNum(Min, Max) {
			var Range = Max - Min;
			var Rand = Math.random();
			return(Min + Math.round(Rand * Range));
		}

		function ListToAdmin(option) {
			this.id = option.id;
			this.list = option.list;
			var ele = document.querySelector(id);

			var data = this.list;

			for(var i = 0; i < data.length; i++) {
				folistsinge(ele, data[i]);
			}

			//console.dir(JSON.stringify(this.list));  

		}
		var chatconhtml = '';

		function folistsinge(id, data) {
//			console.dir(id);
			console.log(data.uname);
			var div2 = document.createElement('li');
			div2.className = 'mui-table-view-cell';
			div2.setAttribute("data-uname", data.uname);
			div2.setAttribute("data-fullname", data.fullname);
			var div = '';
			div += '<img class="admin-userimg" data-uid="' + data.uname + '" src="' + data.logo + '" alt="" />'
			div += '<div class="admin-name" data-uid="' + data.uname + '">'
			div += data.fullname
			div += '</div>'
			div2.innerHTML = div;
			chatconhtml+='<div id="msg-list" data-uid="' + data.uname + '" style="display:none;">'
			chatconhtml+='</div>';
			document.querySelector('.mui-content').innerHTML=chatconhtml;
			if(id.appendChild) {
				id.appendChild(div2);
			} else {
				id.append(div2);
			}
			div2.addEventListener('click', function() {
				var attr = div2.getAttribute('data-uname');
				var atr = document.querySelector('#msg-list').getAttribute('data-uid');
				document.querySelector(".sentofin").innerHTML = div2.getAttribute('data-fullname');
				document.querySelector(".hiddeninput").value = div2.getAttribute('data-uname');
				$('#msg-list[data-uid='+attr+']').show().siblings().hide();
				document.querySelector('#header').style.display = 'none';
				document.querySelector('#chatz1').style.display = 'none';
				document.querySelector('#chatz').style.display = 'block';
				document.querySelector('#header1').style.display = 'block';
				document.querySelector('footer').style.display = 'block';
				document.querySelector('.titlekefu').innerHTML=div2.getAttribute('data-fullname');
				//				mui.openWindow({
				//					url: 'chat.html',
				//					id: 'app/chat/chat.html',
				//					createNew: false, //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
				//					waiting: {
				//						autoShow: true, //自动显示等待框，默认为true
				//						title: '正在加载...', //等待对话框上显示的提示内容
				//					}
				//				})
			})
			
		}
	</script>

</html>